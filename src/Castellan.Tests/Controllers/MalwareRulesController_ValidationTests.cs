using System;
using System.Collections.Generic;
using System.Reflection;
using Xunit;
using Castellan.Worker.Controllers;
using Castellan.Worker.Models;
using FluentAssertions;
using Microsoft.Extensions.Logging;
using Moq;
using Castellan.Worker.Abstractions;

namespace Castellan.Tests.Controllers;

/// <summary>
/// Tests for YARA rule validation and DTO conversion in MalwareRulesController
/// </summary>
[Collection("TestEnvironment")]
public class MalwareRulesController_ValidationTests : IDisposable
{
    private readonly Mock<ILogger<MalwareRulesController>> _mockLogger;
    private readonly Mock<IMalwareRuleStore> _mockRuleStore;
    private readonly MalwareRulesController _controller;

    public MalwareRulesController_ValidationTests()
    {
        _mockLogger = new Mock<ILogger<MalwareRulesController>>();
        _mockRuleStore = new Mock<IMalwareRuleStore>();
        _controller = new MalwareRulesController(_mockLogger.Object, _mockRuleStore.Object);
    }

    public void Dispose()
    {
        // Controllers don't implement IDisposable
    }

    #region YARA Rule Validation Tests

    [Theory]
    [InlineData("", false, "Rule content cannot be empty")]
    [InlineData("   ", false, "Rule content cannot be empty")]
    [InlineData(null, false, "Rule content cannot be empty")]
    public void ValidateMalwareRule_EmptyOrNullContent_ReturnsFalse(string? ruleContent, bool expectedValid, string expectedError)
    {
        // Act
        var result = InvokeValidateMalwareRule(ruleContent);

        // Assert
        result.IsValid.Should().Be(expectedValid);
        result.Error.Should().Be(expectedError);
    }

    [Fact]
    public void ValidateMalwareRule_MissingRuleKeyword_ReturnsFalse()
    {
        // Arrange
        var ruleContent = "badstuff TestName { condition: true }";

        // Act
        var result = InvokeValidateMalwareRule(ruleContent);

        // Assert
        result.IsValid.Should().BeFalse();
        result.Error.Should().Be("Invalid YARA rule: missing 'rule' keyword");
    }

    [Theory]
    [InlineData("rule TestRule condition: true }", false, "Invalid YARA rule: missing braces")]
    [InlineData("rule TestRule { condition: true", false, "Invalid YARA rule: missing braces")]
    [InlineData("rule TestRule condition: true", false, "Invalid YARA rule: missing braces")]
    public void ValidateMalwareRule_MissingBraces_ReturnsFalse(string ruleContent, bool expectedValid, string expectedError)
    {
        // Act
        var result = InvokeValidateMalwareRule(ruleContent);

        // Assert
        result.IsValid.Should().Be(expectedValid);
        result.Error.Should().Be(expectedError);
    }

    [Fact]
    public void ValidateMalwareRule_MissingCondition_ReturnsFalse()
    {
        // Arrange
        var ruleContent = "rule TestRule { strings: $a = \"test\" }";

        // Act
        var result = InvokeValidateMalwareRule(ruleContent);

        // Assert
        result.IsValid.Should().BeFalse();
        result.Error.Should().Be("Invalid YARA rule: missing 'condition' section");
    }

    [Theory]
    [InlineData("rule TestRule { condition: true }")]
    [InlineData("rule ComplexRule { strings: $a = \"malware\" $b = /regex/ condition: $a or $b }")]
    [InlineData(@"rule MultilineRule { 
                    meta:
                        description = ""Test rule""
                        author = ""Test""
                    strings:
                        $string1 = ""pattern1""
                        $string2 = {01 02 03 04}
                    condition:
                        any of them
                }")]
    public void ValidateMalwareRule_ValidRuleContent_ReturnsTrue(string ruleContent)
    {
        // Act
        var result = InvokeValidateMalwareRule(ruleContent);

        // Assert
        result.IsValid.Should().BeTrue();
        result.Error.Should().BeNull();
    }

    [Fact]
    public void ValidateMalwareRule_CaseInsensitive_ReturnsTrue()
    {
        // Arrange
        var ruleContent = "RULE TestRule { CONDITION: true }";

        // Act
        var result = InvokeValidateMalwareRule(ruleContent);

        // Assert
        result.IsValid.Should().BeTrue();
        result.Error.Should().BeNull();
    }

    #endregion

    #region DTO Conversion Tests

    [Fact]
    public void ConvertToDto_CompleteMalwareRule_MapsAllProperties()
    {
        // Arrange
        var malwareRule = new MalwareRule
        {
            Id = "test-rule-id",
            Name = "TestRule",
            Description = "Test rule description",
            RuleContent = "rule TestRule { condition: true }",
            Category = MalwareRuleCategory.Malware,
            Author = "Test Author",
            CreatedAt = new DateTime(2025, 1, 1, 12, 0, 0, DateTimeKind.Utc),
            UpdatedAt = new DateTime(2025, 1, 2, 12, 0, 0, DateTimeKind.Utc),
            IsEnabled = true,
            Priority = 75,
            ThreatLevel = "High",
            HitCount = 10,
            FalsePositiveCount = 2,
            AverageExecutionTimeMs = 15.5,
            MitreTechniques = new List<string> { "T1059.001", "T1027" },
            Tags = new List<string> { "powershell", "obfuscation" },
            IsValid = true,
            ValidationError = null,
            Source = "Custom"
        };

        // Act
        var dto = InvokeConvertToDto(malwareRule);

        // Assert
        dto.Should().NotBeNull();
        dto.Id.Should().Be("test-rule-id");
        dto.Name.Should().Be("TestRule");
        dto.Description.Should().Be("Test rule description");
        dto.RuleContent.Should().Be("rule TestRule { condition: true }");
        dto.Category.Should().Be(MalwareRuleCategory.Malware);
        dto.Author.Should().Be("Test Author");
        dto.CreatedAt.Should().Be(new DateTime(2025, 1, 1, 12, 0, 0, DateTimeKind.Utc));
        dto.UpdatedAt.Should().Be(new DateTime(2025, 1, 2, 12, 0, 0, DateTimeKind.Utc));
        dto.IsEnabled.Should().BeTrue();
        dto.Priority.Should().Be(75);
        dto.ThreatLevel.Should().Be("High");
        dto.HitCount.Should().Be(10);
        dto.FalsePositiveCount.Should().Be(2);
        dto.AverageExecutionTimeMs.Should().Be(15.5);
        dto.MitreTechniques.Should().BeEquivalentTo(new[] { "T1059.001", "T1027" });
        dto.Tags.Should().BeEquivalentTo(new[] { "powershell", "obfuscation" });
        dto.IsValid.Should().BeTrue();
        dto.ValidationError.Should().BeNull();
        dto.Source.Should().Be("Custom");
    }

    [Fact]
    public void ConvertToDto_MalwareRuleWithValidationError_IncludesError()
    {
        // Arrange
        var malwareRule = new MalwareRule
        {
            Id = "invalid-rule-id",
            Name = "InvalidRule",
            Description = "Invalid rule",
            RuleContent = "invalid rule content",
            IsValid = false,
            ValidationError = "Syntax error on line 1"
        };

        // Act
        var dto = InvokeConvertToDto(malwareRule);

        // Assert
        dto.IsValid.Should().BeFalse();
        dto.ValidationError.Should().Be("Syntax error on line 1");
    }

    [Fact]
    public void ConvertToDto_MalwareRuleWithNullCollections_HandlesGracefully()
    {
        // Arrange
        var malwareRule = new MalwareRule
        {
            Id = "test-rule-id",
            Name = "TestRule",
            Description = "Test rule",
            RuleContent = "rule TestRule { condition: true }",
            MitreTechniques = null!, // Null collection
            Tags = null! // Null collection
        };

        // Act
        var dto = InvokeConvertToDto(malwareRule);

        // Assert
        dto.Should().NotBeNull();
        dto.MitreTechniques.Should().NotBeNull();
        dto.Tags.Should().NotBeNull();
    }

    [Fact]
    public void ConvertToDto_MinimalMalwareRule_MapsDefaults()
    {
        // Arrange
        var malwareRule = new MalwareRule(); // Use all defaults

        // Act
        var dto = InvokeConvertToDto(malwareRule);

        // Assert
        dto.Should().NotBeNull();
        dto.Id.Should().NotBeNullOrEmpty(); // Should have auto-generated ID
        dto.Name.Should().BeEmpty();
        dto.Description.Should().BeEmpty();
        dto.Category.Should().Be("General");
        dto.Author.Should().Be("System");
        dto.IsEnabled.Should().BeTrue();
        dto.Priority.Should().Be(50);
        dto.ThreatLevel.Should().Be("Medium");
        dto.HitCount.Should().Be(0);
        dto.FalsePositiveCount.Should().Be(0);
        dto.AverageExecutionTimeMs.Should().Be(0.0);
        dto.IsValid.Should().BeFalse(); // Default is false
        dto.Source.Should().Be("Custom");
    }

    [Fact]
    public void ConvertToDto_PerformanceMetrics_MapsCorrectly()
    {
        // Arrange
        var malwareRule = new MalwareRule
        {
            Id = "perf-test-rule",
            Name = "PerformanceRule",
            HitCount = 1000,
            FalsePositiveCount = 25,
            AverageExecutionTimeMs = 123.456
        };

        // Act
        var dto = InvokeConvertToDto(malwareRule);

        // Assert
        dto.HitCount.Should().Be(1000);
        dto.FalsePositiveCount.Should().Be(25);
        dto.AverageExecutionTimeMs.Should().Be(123.456);
    }

    #endregion

    
    #region Helper Methods for Private Method Testing

    private (bool IsValid, string? Error) InvokeValidateMalwareRule(string? ruleContent)
    {
        return _controller.ValidateMalwareRule(ruleContent ?? "");
    }

    private MalwareRuleDto InvokeConvertToDto(MalwareRule rule)
    {
        return _controller.ConvertToDto(rule);
    }

    #endregion
}
